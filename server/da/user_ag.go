/*
 * Copyright (C) The Qing Project. All rights reserved.
 *
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */

 /******************************************************************************************
 * This file was automatically generated by mingru (https://github.com/mgenware/mingru)
 * Do not edit this file manually, your changes will be overwritten.
 ******************************************************************************************/

package da

import (
	"database/sql"

	"github.com/mgenware/mingru-go-lib"
)

type TableTypeUser struct {
}

var User = &TableTypeUser{}

// MingruSQLName returns the name of this table.
func (mrTable *TableTypeUser) MingruSQLName() string {
	return "user"
}

// ------------ Actions ------------

func (mrTable *TableTypeUser) AddUserEntryInternal(mrQueryable mingru.Queryable, email string, name string) (uint64, error) {
	result, err := mrQueryable.Exec("INSERT INTO `user` (`email`, `name`, `icon_name`, `created_at`, `company`, `website`, `location`, `bio`, `admin`) VALUES (?, ?, '', UTC_TIMESTAMP(), '', '', '', NULL, 0)", email, name)
	return mingru.GetLastInsertIDUint64WithError(result, err)
}

func (mrTable *TableTypeUser) AddUserStatsEntryInternal(mrQueryable mingru.Queryable, id uint64) error {
	_, err := mrQueryable.Exec("INSERT INTO `user_stats` (`id`, `post_count`, `thread_count`, `thread_msg_count`) VALUES (?, 0, 0, 0)", id)
	return err
}

func (mrTable *TableTypeUser) FindUserByID(mrQueryable mingru.Queryable, id uint64) (FindUserResult, error) {
	var result FindUserResult
	err := mrQueryable.QueryRow("SELECT `id`, `name`, `icon_name` FROM `user` WHERE `id` = ?", id).Scan(&result.ID, &result.Name, &result.IconName)
	if err != nil {
		return result, err
	}
	return result, nil
}

func (mrTable *TableTypeUser) FindUsersByName(mrQueryable mingru.Queryable, name string) ([]FindUserResult, error) {
	rows, err := mrQueryable.Query("SELECT `id`, `name`, `icon_name` FROM `user` WHERE `name` LIKE ?", name)
	if err != nil {
		return nil, err
	}
	var result []FindUserResult
	defer rows.Close()
	for rows.Next() {
		var item FindUserResult
		err = rows.Scan(&item.ID, &item.Name, &item.IconName)
		if err != nil {
			return nil, err
		}
		result = append(result, item)
	}
	err = rows.Err()
	if err != nil {
		return nil, err
	}
	return result, nil
}

type UserTableSelectEditingDataResult struct {
	BioHTML  *string `json:"bioHTML,omitempty"`
	Company  string  `json:"company,omitempty"`
	IconName string  `json:"-"`
	ID       uint64  `json:"-"`
	Location string  `json:"location,omitempty"`
	Name     string  `json:"name,omitempty"`
	Website  string  `json:"website,omitempty"`
}

func (mrTable *TableTypeUser) SelectEditingData(mrQueryable mingru.Queryable, id uint64) (UserTableSelectEditingDataResult, error) {
	var result UserTableSelectEditingDataResult
	err := mrQueryable.QueryRow("SELECT `id`, `name`, `icon_name`, `location`, `company`, `website`, `bio` FROM `user` WHERE `id` = ?", id).Scan(&result.ID, &result.Name, &result.IconName, &result.Location, &result.Company, &result.Website, &result.BioHTML)
	if err != nil {
		return result, err
	}
	return result, nil
}

func (mrTable *TableTypeUser) SelectIconName(mrQueryable mingru.Queryable, id uint64) (string, error) {
	var result string
	err := mrQueryable.QueryRow("SELECT `icon_name` FROM `user` WHERE `id` = ?", id).Scan(&result)
	if err != nil {
		return result, err
	}
	return result, nil
}

func (mrTable *TableTypeUser) SelectIDFromEmail(mrQueryable mingru.Queryable, email string) (uint64, error) {
	var result uint64
	err := mrQueryable.QueryRow("SELECT `id` FROM `user` WHERE `email` = ?", email).Scan(&result)
	if err != nil {
		return result, err
	}
	return result, nil
}

func (mrTable *TableTypeUser) SelectIsAdmin(mrQueryable mingru.Queryable, id uint64) (bool, error) {
	var result bool
	err := mrQueryable.QueryRow("SELECT `admin` FROM `user` WHERE `id` = ?", id).Scan(&result)
	if err != nil {
		return result, err
	}
	return result, nil
}

func (mrTable *TableTypeUser) SelectName(mrQueryable mingru.Queryable, id uint64) (string, error) {
	var result string
	err := mrQueryable.QueryRow("SELECT `name` FROM `user` WHERE `id` = ?", id).Scan(&result)
	if err != nil {
		return result, err
	}
	return result, nil
}

type UserTableSelectProfileResult struct {
	BioHTML  *string `json:"bioHTML,omitempty"`
	Company  string  `json:"company,omitempty"`
	IconName string  `json:"-"`
	ID       uint64  `json:"-"`
	Location string  `json:"location,omitempty"`
	Name     string  `json:"name,omitempty"`
	Website  string  `json:"website,omitempty"`
}

func (mrTable *TableTypeUser) SelectProfile(mrQueryable mingru.Queryable, id uint64) (UserTableSelectProfileResult, error) {
	var result UserTableSelectProfileResult
	err := mrQueryable.QueryRow("SELECT `id`, `name`, `icon_name`, `location`, `company`, `website`, `bio` FROM `user` WHERE `id` = ?", id).Scan(&result.ID, &result.Name, &result.IconName, &result.Location, &result.Company, &result.Website, &result.BioHTML)
	if err != nil {
		return result, err
	}
	return result, nil
}

type UserTableSelectSessionDataResult struct {
	Admin    bool   `json:"admin,omitempty"`
	IconName string `json:"iconName,omitempty"`
	ID       uint64 `json:"id,omitempty"`
	Name     string `json:"name,omitempty"`
}

func (mrTable *TableTypeUser) SelectSessionData(mrQueryable mingru.Queryable, id uint64) (UserTableSelectSessionDataResult, error) {
	var result UserTableSelectSessionDataResult
	err := mrQueryable.QueryRow("SELECT `id`, `name`, `icon_name`, `admin` FROM `user` WHERE `id` = ?", id).Scan(&result.ID, &result.Name, &result.IconName, &result.Admin)
	if err != nil {
		return result, err
	}
	return result, nil
}

type UserTableSelectSessionDataForumModeResult struct {
	Admin      bool    `json:"admin,omitempty"`
	IconName   string  `json:"iconName,omitempty"`
	ID         uint64  `json:"id,omitempty"`
	IsForumMod *uint64 `json:"isForumMod,omitempty"`
	Name       string  `json:"name,omitempty"`
}

func (mrTable *TableTypeUser) SelectSessionDataForumMode(mrQueryable mingru.Queryable, id uint64) (UserTableSelectSessionDataForumModeResult, error) {
	var result UserTableSelectSessionDataForumModeResult
	err := mrQueryable.QueryRow("SELECT `user`.`id`, `user`.`name`, `user`.`icon_name`, `user`.`admin`, `join_1`.`id` AS `is_forum_mod` FROM `user` AS `user` LEFT JOIN `forum_is_user_mod` AS `join_1` ON `join_1`.`id` = `user`.`id` WHERE `user`.`id` = ?", id).Scan(&result.ID, &result.Name, &result.IconName, &result.Admin, &result.IsForumMod)
	if err != nil {
		return result, err
	}
	return result, nil
}

func (mrTable *TableTypeUser) testAddUserChild2(mrQueryable mingru.Queryable, id uint64) error {
	return mrTable.AddUserStatsEntryInternal(mrQueryable, id)
}

func (mrTable *TableTypeUser) TestAddUser(db *sql.DB, email string, name string) (uint64, error) {
	var insertedUserIDExported uint64
	txErr := mingru.Transact(db, func(tx *sql.Tx) error {
		var err error
		insertedUserID, err := mrTable.AddUserEntryInternal(tx, email, name)
		if err != nil {
			return err
		}
		err = mrTable.testAddUserChild2(tx, insertedUserID)
		if err != nil {
			return err
		}
		insertedUserIDExported = insertedUserID
		return nil
	})
	return insertedUserIDExported, txErr
}

func (mrTable *TableTypeUser) testEraseUserChild1(mrQueryable mingru.Queryable, id uint64) (int, error) {
	result, err := mrQueryable.Exec("DELETE FROM `user` WHERE `id` = ?", id)
	return mingru.GetRowsAffectedIntWithError(result, err)
}

func (mrTable *TableTypeUser) testEraseUserChild2(mrQueryable mingru.Queryable, id uint64) (int, error) {
	result, err := mrQueryable.Exec("DELETE FROM `user_stats` WHERE `id` = ?", id)
	return mingru.GetRowsAffectedIntWithError(result, err)
}

func (mrTable *TableTypeUser) TestEraseUser(db *sql.DB, id uint64) error {
	txErr := mingru.Transact(db, func(tx *sql.Tx) error {
		var err error
		_, err = mrTable.testEraseUserChild1(tx, id)
		if err != nil {
			return err
		}
		_, err = mrTable.testEraseUserChild2(tx, id)
		if err != nil {
			return err
		}
		return nil
	})
	return txErr
}

type UserTableUnsafeSelectAdminsResult struct {
	IconName string `json:"-"`
	ID       uint64 `json:"-"`
	Name     string `json:"name,omitempty"`
}

func (mrTable *TableTypeUser) UnsafeSelectAdmins(mrQueryable mingru.Queryable) ([]UserTableUnsafeSelectAdminsResult, error) {
	rows, err := mrQueryable.Query("SELECT `id`, `name`, `icon_name` FROM `user` WHERE `admin` = 1 ORDER BY `id`")
	if err != nil {
		return nil, err
	}
	var result []UserTableUnsafeSelectAdminsResult
	defer rows.Close()
	for rows.Next() {
		var item UserTableUnsafeSelectAdminsResult
		err = rows.Scan(&item.ID, &item.Name, &item.IconName)
		if err != nil {
			return nil, err
		}
		result = append(result, item)
	}
	err = rows.Err()
	if err != nil {
		return nil, err
	}
	return result, nil
}

func (mrTable *TableTypeUser) UnsafeUpdateAdmin(mrQueryable mingru.Queryable, id uint64, admin bool) error {
	result, err := mrQueryable.Exec("UPDATE `user` SET `admin` = ? WHERE `id` = ?", admin, id)
	return mingru.CheckOneRowAffectedWithError(result, err)
}

func (mrTable *TableTypeUser) UpdateIconName(mrQueryable mingru.Queryable, id uint64, iconName string) error {
	result, err := mrQueryable.Exec("UPDATE `user` SET `icon_name` = ? WHERE `id` = ?", iconName, id)
	return mingru.CheckOneRowAffectedWithError(result, err)
}

func (mrTable *TableTypeUser) UpdateProfile(mrQueryable mingru.Queryable, id uint64, name string, website string, company string, location string, bioHTML *string) error {
	result, err := mrQueryable.Exec("UPDATE `user` SET `name` = ?, `website` = ?, `company` = ?, `location` = ?, `bio` = ? WHERE `id` = ?", name, website, company, location, bioHTML, id)
	return mingru.CheckOneRowAffectedWithError(result, err)
}
