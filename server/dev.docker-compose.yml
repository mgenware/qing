#
# Copyright (C) The Qing Project. All rights reserved.
#
# Use of this source code is governed by a license that
# can be found in the LICENSE file.
#

# This file was automatically generated by running `qing conf`
# Do not edit this file manually, your changes will be overwritten.

version: '3.9'
services:
  server:
    environment:
      - QING_DCONF
    build:
      context: .
      dockerfile: dev.dockerfile
    volumes:
      - ../web/src/css:/qing/dev/css
      - ../userland/dev_config:/qing/dev/config
      - ../server:/qing/dev/server
      - ../userland/templates:/qing/templates
      - ../userland/static:/qing/static
      - ../userland/langs/server:/qing/langs
      - ../userland/misc:/qing/misc
      - ../volumes/qing_data:/qing_data
    ports:
      - '8000:8000'
    depends_on:
      - ms
      - db
      - img_proxy
  ms:
    image: redis:7
    ports:
      - '6379:6379'
  db:
    image: mariadb:10.6
    ports:
      - '3306:3306'
    environment:
      MYSQL_ROOT_PASSWORD: qing_dev_root_pwd
      MYSQL_USER: qing_dev
      MYSQL_PASSWORD: qing_dev_pwd
      MYSQL_DATABASE: qing_dev
  migrate:
    image: migrate/migrate
    profiles:
      - oth
    volumes:
      - ../migrations:/qing/migrations
    entrypoint:
      - migrate
      - '-path'
      - /qing/migrations
      - '-database'
      - mysql://qing_dev:qing_dev_pwd@tcp(db:3306)/qing_dev?multiStatements=true
    depends_on:
      - db
  img_proxy:
    image: h2non/imaginary
    ports:
      - '9000:9000'
    command: '-enable-url-source'
    volumes:
      - ../volumes/qing_data:/qing_data
